#!/bin/bash
# SMTP server startup script with proper environment setup

echo "SMTP startup script started at $(date)"

# Wait for outline directory to be ready
while [ ! -d "/home/ubuntu/outline/node_modules" ]; do
    echo "Waiting for outline node_modules to be available..."
    sleep 2
done

echo "Found node_modules directory"

# Change to outline directory
cd /home/ubuntu/outline || {
    echo "ERROR: Failed to change to /home/ubuntu/outline"
    exit 1
}

# Set NODE_PATH to find modules
export NODE_PATH="/home/ubuntu/outline/node_modules"

# Verify required modules exist
if [ ! -f "/home/ubuntu/outline/node_modules/smtp-server/package.json" ]; then
    echo "ERROR: smtp-server module not found"
    exit 1
fi

if [ ! -f "/home/ubuntu/outline/node_modules/mailparser/package.json" ]; then
    echo "ERROR: mailparser module not found"
    exit 1
fi

echo "All required modules found"

# Start the SMTP server
echo "Starting SMTP server with NODE_PATH=$NODE_PATH"
exec node /usr/local/bin/local-smtp-server