#!/bin/bash
# Start Outline server (use after import)

set -e

# Find outline directory
OUTLINE_DIR=""
if [ -d "/home/ubuntu/outline" ] && [ -f "/home/ubuntu/outline/package.json" ]; then
    OUTLINE_DIR="/home/ubuntu/outline"
elif [ -d "/opt/outline" ] && [ -f "/opt/outline/package.json" ]; then
    OUTLINE_DIR="/opt/outline"
else
    echo "âŒ Outline directory not found. Checked:"
    echo "   - /home/ubuntu/outline"
    echo "   - /opt/outline"
    exit 1
fi

echo "ğŸ“ Using Outline directory: $OUTLINE_DIR"
cd "$OUTLINE_DIR"

# Check if setup is complete
if [ ! -f /home/ubuntu/outline/.import-ready ] && [ ! -f /home/ubuntu/outline/.production-ready ]; then
    echo "âŒ Setup not complete. Run setup-outline-import first."
    exit 1
fi

# Check if environment exists
ENV_FILE=""
if [ -f /home/ubuntu/outline/.env ]; then
    ENV_FILE="/home/ubuntu/outline/.env"
elif [ -f "$OUTLINE_DIR/.env" ]; then
    ENV_FILE="$OUTLINE_DIR/.env"
else
    echo "âŒ Environment file missing. Run setup first."
    exit 1
fi

echo "ğŸ“‹ Using environment file: $ENV_FILE"

# Load environment
source "$ENV_FILE"

# Check database connection
echo "ğŸ” Checking database connection..."
if ! psql "$DATABASE_URL" -c "SELECT 1;" > /dev/null 2>&1; then
    echo "âŒ Database connection failed. Check if data is imported."
    exit 1
fi

# Check if database has data
TABLE_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ' || echo "0")
if [ "$TABLE_COUNT" -eq 0 ]; then
    echo "âŒ Database is empty. Import your data first with:"
    echo "   outline-cli import-full -d /path/to/backup --force"
    exit 1
fi

echo "âœ… Database ready with $TABLE_COUNT tables"
echo "ğŸš€ Starting Outline server..."

# Start the server
if command -v yarn > /dev/null 2>&1; then
    echo "ğŸš€ Starting with yarn..."
    exec yarn start
else
    echo "ğŸš€ Starting with node directly..."
    exec node ./build/server/index.js
fi