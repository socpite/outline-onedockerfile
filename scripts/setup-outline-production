#!/bin/bash
set -e

echo "🚀 Setting up Outline for production..."

# Wait for PostgreSQL and Redis to be ready
echo "⏳ Waiting for services to be ready..."
for i in {1..60}; do
    if sudo -u postgres pg_isready > /dev/null 2>&1 && redis-cli ping > /dev/null 2>&1; then
        echo "✅ Services are ready!"
        break
    fi
    echo "   Waiting for PostgreSQL and Redis... ($i/60)"
    sleep 2
done

# Create outline user if it doesn't exist
sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'outline'" | grep -q 1 || {
    echo "📋 Creating outline user..."
    sudo -u postgres psql -c "CREATE USER outline WITH PASSWORD 'outline_password';"
}

echo "📋 Granting user privileges..."
sudo -u postgres psql -c "ALTER USER outline CREATEDB;"
sudo -u postgres psql -c "ALTER USER outline CREATEROLE;"

# Generate secure secrets
SECRET_KEY=$(openssl rand -hex 32)
UTILS_SECRET=$(openssl rand -hex 32)

# Set environment variables
echo "🌍 Setting production environment variables..."
mkdir -p /home/ubuntu/outline
cat > /home/ubuntu/outline/.env << ENVEOF
NODE_ENV=production
DATABASE_URL="postgres://outline:outline_password@127.0.0.1:5432/outline?sslmode=disable"
REDIS_URL="redis://127.0.0.1:6379"
SECRET_KEY="$SECRET_KEY"
UTILS_SECRET="$UTILS_SECRET"
URL="http://localhost:3000"
FORCE_HTTPS=false
FILE_STORAGE=local
FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
LOG_LEVEL=info

# Enable Email Authentication
ENABLED_PLUGINS=email
SMTP_HOST=127.0.0.1
SMTP_PORT=1025
SMTP_USERNAME=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=noreply@outline.local
SMTP_REPLY_EMAIL=support@outline.local
SMTP_SECURE=false
ENVEOF

# Create database using yarn db:create
echo "📋 Creating database..."
cd /home/ubuntu/outline
DATABASE_URL="postgres://outline:outline_password@127.0.0.1:5432/outline?sslmode=disable" yarn db:create --env=production-ssl-disabled

echo "📋 Granting database privileges..."
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE outline TO outline;"
sudo -u postgres psql -d outline -c "
GRANT ALL ON SCHEMA public TO outline;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO outline;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO outline;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO outline;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO outline;
" > /dev/null 2>&1

# Build the application
echo "🔨 Building Outline application..."
cd /home/ubuntu/outline
yarn build

# Run database migrations
echo "🗃️  Running database migrations..."
DATABASE_URL="postgres://outline:outline_password@127.0.0.1:5432/outline?sslmode=disable" yarn db:migrate --env=production-ssl-disabled

# Set proper ownership
echo "📋 Setting file ownership..."
chown -R ubuntu:ubuntu /home/ubuntu/outline
chown -R ubuntu:ubuntu /var/lib/outline

echo "✅ Production setup complete!"
echo "🌐 Outline will be available at: http://localhost:3000"
echo "📧 SMTP server will capture login emails on port 1025"
echo "🖥️  VNC Desktop available at: http://localhost:6080/vnc.html"