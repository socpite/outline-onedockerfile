#!/bin/bash
# Production Outline startup script

set -e

cd /home/ubuntu/outline

echo "ğŸš€ Starting Outline production server..."

# Wait for database to be ready
echo "â³ Waiting for database..."
for i in {1..30}; do
    if pg_isready -h localhost -p 5432 -U outline >/dev/null 2>&1; then
        echo "âœ… Database is ready"
        break
    fi
    echo "   Waiting for database... ($i/30)"
    sleep 2
done

# Wait for Redis to be ready
echo "â³ Waiting for Redis..."
for i in {1..30}; do
    if redis-cli ping >/dev/null 2>&1; then
        echo "âœ… Redis is ready"
        break
    fi
    echo "   Waiting for Redis... ($i/30)"
    sleep 2
done

# Load environment variables
if [[ -f .env.production ]]; then
    echo "ğŸ“‹ Loading production environment..."
    export $(grep -v '^#' .env.production | xargs)
elif [[ -f .env ]]; then
    echo "ğŸ“‹ Loading development environment..."
    export $(grep -v '^#' .env | xargs)
else
    echo "âŒ No environment file found!"
    exit 1
fi

# Run database migrations
echo "ğŸ—ƒï¸  Running database migrations..."
yarn db:migrate --env=production-ssl-disabled

# Start the production server
echo "ğŸ‰ Starting Outline server..."
exec yarn start